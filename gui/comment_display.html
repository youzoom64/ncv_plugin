<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>„Éã„Ç≥Áîü„Ç≥„É°„É≥„ÉàË°®Á§∫</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Hachi+Maru+Pop&family=Klee+One&family=RocknRoll+One&family=New+Tegomin&family=Train+One&family=DotGothic16&family=Reggae+One&family=Yuji+Syuku&family=Yuji+Boku&family=Mochiy+Pop+One&family=Kaisei+HarunoUmi&family=Shippori+Antique&family=Stick&family=Rampart+One&family=Zen+Antique&family=Mochiy+Pop+P+One&family=Zen+Kurenaido&family=Yusei+Magic&display=swap"
      rel="stylesheet"
      onerror="console.error('Google FontsË™≠„ÅøËæº„ÅøÂ§±Êïó„ÄÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Éï„Ç©„É≥„Éà„Çí‰ΩøÁî®');"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        background: transparent;
        overflow: hidden;
        font-family: "DotGothic16", sans-serif;
      }

      #comment-container {
        position: relative;
        width: 512px;
        height: 100vh;
        margin: 0 auto;
      }

      .comment-item {
        position: absolute;
        width: 512px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding-left: 10px;
        transition: all 0.3s ease-out;
        opacity: 0;
        transform: translateX(100%);
      }

      .comment-item.show {
        opacity: 1;
        transform: translateX(0);
      }

      /* „Ç≥„É°„É≥„Éà„ÇíÁ¢∫ÂÆü„Å´Ë°®Á§∫Áä∂ÊÖã„Å´‰øù„Å§ */
      .comment-item.visible {
        opacity: 1 !important;
        transform: translateX(0) !important;
        display: flex !important;
      }

      .comment-item.moving-up {
        transition: all 0.2s ease-out;
      }

      .comment-text {
        color: #ffffff;
        text-shadow: -1px -1px 0 #000, /* Â∑¶‰∏ä */ 1px -1px 0 #000,
          /* Âè≥‰∏ä */ -1px 1px 0 #000, /* Â∑¶‰∏ã */ 1px 1px 0 #000,
          /* Âè≥‰∏ã */ 2px 2px 4px rgba(0, 0, 0, 0.8); /* „Åº„Åã„ÅóÂΩ± */
        font-weight: bold;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 480px;
        flex: 1;
        position: relative;
        z-index: 2;
      }

      /* ÈÅãÂñ∂„Ç≥„É°„É≥„ÉàÂ∞ÇÁî®„Çπ„Çø„Ç§„É´ */
      .comment-text.operator {
        color: #ffff00;
        text-shadow: 2px 2px 4px rgba(255, 0, 0, 0.8);
        font-weight: bold;
        font-size: 18px;
      }

      /* „Éï„Ç©„É≥„ÉàÂÆöÁæ©Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ‰ªò„ÅçÔºâ */
      .font-0 {
        font-family: "DotGothic16", "MS Gothic", monospace, sans-serif;
      } /* „Éá„Éï„Ç©„É´„Éà */
      .font-1 {
        font-family: "Dela Gothic One", "MS Gothic", cursive, sans-serif;
      }
      .font-2 {
        font-family: "Hachi Maru Pop", "MS Gothic", cursive, sans-serif;
      }
      .font-3 {
        font-family: "Klee One", "MS Mincho", cursive, serif;
      }
      .font-4 {
        font-family: "RocknRoll One", "MS Gothic", cursive, sans-serif;
      }
      .font-5 {
        font-family: "New Tegomin", "MS Mincho", serif, sans-serif;
      }
      .font-6 {
        font-family: "Train One", "MS Gothic", cursive, sans-serif;
      }
      .font-7 {
        font-family: "DotGothic16", "MS Gothic", monospace, sans-serif;
      }
      .font-8 {
        font-family: "Reggae One", "MS Gothic", cursive, sans-serif;
      }
      .font-9 {
        font-family: "Yuji Syuku", "MS Mincho", serif, sans-serif;
      }
      .font-10 {
        font-family: "Yuji Boku", "MS Mincho", serif, sans-serif;
      }
      .font-11 {
        font-family: "Mochiy Pop One", "MS Gothic", sans-serif;
      }
      .font-12 {
        font-family: "Kaisei HarunoUmi", "MS Mincho", serif, sans-serif;
      }
      .font-13 {
        font-family: "Shippori Antique", "MS Mincho", serif, sans-serif;
      }
      .font-14 {
        font-family: "Stick", "MS Gothic", sans-serif;
      }
      .font-15 {
        font-family: "Rampart One", "MS Gothic", cursive, sans-serif;
      }
      .font-16 {
        font-family: "Zen Antique", "MS Mincho", serif, sans-serif;
      }
      .font-17 {
        font-family: "Mochiy Pop P One", "MS Gothic", sans-serif;
      }
      .font-18 {
        font-family: "Zen Kurenaido", "MS Gothic", sans-serif;
      }
      .font-19 {
        font-family: "Yusei Magic", "MS Gothic", sans-serif;
      }

      /* „Éï„Ç©„É≥„Éà„Éó„É¨„Éì„É•„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ÔºàÊèê‰æõ„Åï„Çå„ÅüCSS„Å®Âêå„ÅòÔºâ */
      .font-preview {
        margin-top: 10px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 2px solid #dee2e6;
        font-size: 1.3em;
        color: #2c3e50;
        text-align: center;
      }

      /* „Éï„Ç©„É≥„Éà„Éó„É¨„Éì„É•„ÉºÁî®„ÅÆÂêÑ„Éï„Ç©„É≥„Éà„ÇØ„É©„Çπ */
      .font-preview.font-0 {
        font-family: "DotGothic16", "MS Gothic", monospace, sans-serif;
      }
      .font-preview.font-1 {
        font-family: "Dela Gothic One", "MS Gothic", cursive, sans-serif;
      }
      .font-preview.font-2 {
        font-family: "Hachi Maru Pop", "MS Gothic", cursive, sans-serif;
      }
      .font-preview.font-3 {
        font-family: "Klee One", "MS Mincho", cursive, serif;
      }
      .font-preview.font-4 {
        font-family: "RocknRoll One", "MS Gothic", cursive, sans-serif;
      }
      .font-preview.font-5 {
        font-family: "New Tegomin", "MS Mincho", serif, sans-serif;
      }
      .font-preview.font-6 {
        font-family: "Train One", "MS Gothic", cursive, sans-serif;
      }
      .font-preview.font-7 {
        font-family: "DotGothic16", "MS Gothic", monospace, sans-serif;
      }
      .font-preview.font-8 {
        font-family: "Reggae One", "MS Gothic", cursive, sans-serif;
      }
      .font-preview.font-9 {
        font-family: "Yuji Syuku", "MS Mincho", serif, sans-serif;
      }
      .font-preview.font-10 {
        font-family: "Yuji Boku", "MS Mincho", serif, sans-serif;
      }
      .font-preview.font-11 {
        font-family: "Mochiy Pop One", "MS Gothic", sans-serif;
      }
      .font-preview.font-12 {
        font-family: "Kaisei HarunoUmi", "MS Mincho", serif, sans-serif;
      }
      .font-preview.font-13 {
        font-family: "Shippori Antique", "MS Mincho", serif, sans-serif;
      }
      .font-preview.font-14 {
        font-family: "Stick", "MS Gothic", sans-serif;
      }
      .font-preview.font-15 {
        font-family: "Rampart One", "MS Gothic", cursive, sans-serif;
      }
      .font-preview.font-16 {
        font-family: "Zen Antique", "MS Mincho", serif, sans-serif;
      }
      .font-preview.font-17 {
        font-family: "Mochiy Pop P One", "MS Gothic", sans-serif;
      }
      .font-preview.font-18 {
        font-family: "Zen Kurenaido", "MS Gothic", sans-serif;
      }
      .font-preview.font-19 {
        font-family: "Yusei Magic", "MS Gothic", sans-serif;
      }

      /* „Çπ„Ç≠„É≥ËÉåÊôØ */
      .skin-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        z-index: 1;
        pointer-events: none;
      }

      /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„Ç≠„Éº„Éï„É¨„Éº„É† */
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(-32px);
        }
      }

      .slide-in {
        animation: slideIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      }

      .slide-up {
        animation: slideUp 0.2s ease-out forwards;
      }
    </style>
  </head>
  <body>
    <div id="comment-container">
      <!-- „Ç≥„É°„É≥„Éà„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
    </div>

    <script>
      // „Éï„Ç©„É≥„ÉàË™≠„ÅøËæº„ÅøÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç
      document.fonts.ready.then(() => {
        console.log("üé® ÂÖ®„Éï„Ç©„É≥„ÉàË™≠„ÅøËæº„ÅøÂÆå‰∫Ü");
        document.fonts.forEach((font) => {
          console.log(
            `‚úÖ Ë™≠„ÅøËæº„ÅøÊ∏à„Åø„Éï„Ç©„É≥„Éà: ${font.family} ${font.style} ${font.weight}`
          );
        });
      });

      // „Éï„Ç©„É≥„ÉàË™≠„ÅøËæº„ÅøÂ§±ÊïóÊôÇ„ÅÆÂá¶ÁêÜ
      document.fonts.addEventListener("loadingerror", (event) => {
        console.error("‚ùå „Éï„Ç©„É≥„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:", event);
      });
    </script>
    <script>
      class CommentDisplay {
        constructor() {
          this.container = document.getElementById("comment-container");
          this.comments = [];
          this.maxComments = 20; // ÊúÄÂ§ßË°®Á§∫„Ç≥„É°„É≥„ÉàÊï∞
          this.autoScrollTimer = null;
          this.autoScrollInterval = 60000; // 60ÁßíÔºà1ÂàÜÔºâ

          this.init();
        }

        init() {
          this.connectWebSocket();
          this.startAutoScroll();
          this.loadSkinImages();
        }

        // WebSocketÊé•Á∂ö
        connectWebSocket() {
          try {
            this.ws = new WebSocket("ws://localhost:8080/ws");

            this.ws.onopen = () => {
              console.log("WebSocketÊé•Á∂öÂÆå‰∫Ü");
            };

            this.ws.onmessage = (event) => {
              try {
                const data = JSON.parse(event.data);
                if (data.type === "comment") {
                  this.addComment(data);
                }
              } catch (e) {
                console.error("WebSocket„Éá„Éº„ÇøËß£Êûê„Ç®„É©„Éº:", e);
              }
            };

            this.ws.onerror = (error) => {
              console.error("WebSocket„Ç®„É©„Éº:", error);
            };

            this.ws.onclose = () => {
              console.log("WebSocketÊé•Á∂öÁµÇ‰∫Ü");
              // ÂÜçÊé•Á∂ö„ÇíË©¶Ë°å
              setTimeout(() => this.connectWebSocket(), 5000);
            };
          } catch (e) {
            console.error("WebSocketÊé•Á∂ö„Ç®„É©„Éº:", e);
          }
        }

        // „Çπ„Ç≠„É≥ÁîªÂÉèË™≠„ÅøËæº„Åø
        loadSkinImages() {
          this.skinImages = {};
          // „Çπ„Ç≠„É≥ÁîªÂÉè„ÅÆ„Éó„É™„É≠„Éº„ÉâÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
          console.log("„Çπ„Ç≠„É≥ÁîªÂÉèË™≠„ÅøËæº„ÅøÂÆå‰∫Ü");
        }

        // „Ç≥„É°„É≥„ÉàËøΩÂä†
        addComment(data) {
          console.log("„Ç≥„É°„É≥„ÉàËøΩÂä†:", data); // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†

          const comment = {
            id: Date.now() + Math.random(),
            text: data.text || "",
            skin: data.skin || null,
            font: data.font || 0,
            timestamp: Date.now(),
          };

          console.log("Âá¶ÁêÜÂæå„ÅÆ„Ç≥„É°„É≥„Éà:", comment); // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†

          // „Ç≥„É°„É≥„Éà„É™„Çπ„Éà„Å´ËøΩÂä†
          this.comments.push(comment);

          // ÊúÄÂ§ßË°®Á§∫Êï∞„ÇíË∂Ö„Åà„Åü„ÇâÂè§„ÅÑ„Ç≥„É°„É≥„Éà„ÇíÂâäÈô§
          if (this.comments.length > this.maxComments) {
            this.comments.shift();
          }

          // Êó¢Â≠ò„Ç≥„É°„É≥„Éà„Çí‰∏ä„Å´ÁßªÂãï
          this.moveAllCommentsUp();

          // Êñ∞„Åó„ÅÑ„Ç≥„É°„É≥„Éà„ÇíË°®Á§∫
          this.displayComment(comment);

          // „Ç≥„É°„É≥„Éà„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
          this.updateCommentPositions();
        }

        // „Ç≥„É°„É≥„ÉàË°®Á§∫
        displayComment(comment) {
          console.log("„Çπ„Ç≠„É≥„Éª„Éï„Ç©„É≥„ÉàÈÅ©Áî®Ë©≥Á¥∞:", {
            skin: comment.skin,
            font: comment.font,
            text: comment.text,
          });

          const commentElement = document.createElement("div");
          commentElement.className = "comment-item";
          commentElement.id = `comment-${comment.id}`;
          commentElement.style.bottom = "0px";

          // „Çπ„Ç≠„É≥ËÉåÊôØË®≠ÂÆö
          console.log(
            `üé® „Çπ„Ç≠„É≥Âá¶ÁêÜÈñãÂßã - comment.skin: ${
              comment.skin
            } (Âûã: ${typeof comment.skin})`
          );

          let skinPath;
          if (
            comment.skin &&
            comment.skin !== null &&
            comment.skin !== "null"
          ) {
            skinPath = `http://localhost:8080/skin/${comment.skin}.png`;
            console.log(`üñºÔ∏è „Ç´„Çπ„Çø„É†„Çπ„Ç≠„É≥‰ΩøÁî®: ${skinPath}`);
          } else {
            skinPath = `http://localhost:8080/skin/6.png`;
            console.log(`üñºÔ∏è „Éá„Éï„Ç©„É´„Éà„Çπ„Ç≠„É≥‰ΩøÁî®: ${skinPath}`);
          }

          const skinBg = document.createElement("div");
          skinBg.className = "skin-bg";
          skinBg.style.backgroundImage = `url('${skinPath}')`;

          console.log(
            `üéØ „Çπ„Ç≠„É≥Ë¶ÅÁ¥†‰ΩúÊàêÂÆå‰∫Ü - backgroundImage: ${skinBg.style.backgroundImage}`
          );

          // „Çπ„Ç≠„É≥Ë™≠„ÅøËæº„ÅøÁ¢∫Ë™ç
          const testImg = new Image();
          testImg.onload = () => {
            console.log(`‚úÖ „Çπ„Ç≠„É≥Ë™≠„ÅøËæº„ÅøÊàêÂäü: ${skinPath}`);
          };
          testImg.onerror = () => {
            console.error(`‚ùå „Çπ„Ç≠„É≥Ë™≠„ÅøËæº„ÅøÂ§±Êïó: ${skinPath}`);
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Çπ„Ç≠„É≥„ÇíË©¶Ë°å
            skinBg.style.backgroundImage = `url('http://localhost:8080/skin/6.png')`;
          };
          testImg.src = skinPath;

          commentElement.appendChild(skinBg);
          console.log(`üì¶ „Çπ„Ç≠„É≥Ë¶ÅÁ¥†„Çí„Ç≥„É°„É≥„Éà„Å´ËøΩÂä†ÂÆå‰∫Ü`);

          // „Ç≥„É°„É≥„Éà„ÉÜ„Ç≠„Çπ„Éà
          const fontClass = `font-${comment.font || 0}`;
          const textElement = document.createElement("div");

          // ÈÅãÂñ∂„Ç≥„É°„É≥„Éà„ÅÆÂ†¥Âêà„ÅØÁâπÂà•„Å™„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
          if (comment.is_operator || comment.text.startsWith("[ÈÅãÂñ∂]")) {
            textElement.className = `comment-text operator ${fontClass}`;
            console.log("üéñÔ∏è ÈÅãÂñ∂„Ç≥„É°„É≥„Éà„Çπ„Çø„Ç§„É´ÈÅ©Áî®");
          } else {
            textElement.className = `comment-text ${fontClass}`;
          }

          textElement.textContent = comment.text;
          console.log(`„Éï„Ç©„É≥„Éà„ÇØ„É©„ÇπÈÅ©Áî®: ${fontClass}`);

          // „Éï„Ç©„É≥„ÉàÈÅ©Áî®Á¢∫Ë™ç
          const computedStyle = window.getComputedStyle(textElement);
          console.log(`ÂÆüÈöõ„ÅÆ„Éï„Ç©„É≥„Éà: ${computedStyle.fontFamily}`);

          commentElement.appendChild(textElement);

          // „Ç≥„É≥„ÉÜ„Éä„Å´ËøΩÂä†
          this.container.appendChild(commentElement);

          // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßãÔºàÂè≥„Åã„ÇâÂ∑¶„Å´È£õ„Å≥Ëæº„ÇÄÔºâ
          requestAnimationFrame(() => {
            commentElement.classList.add("slide-in");
            console.log("„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã:", comment.text);
          });

          // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÂæå„ÅÆÂá¶ÁêÜÔºàË°®Á§∫Áä∂ÊÖã„ÇíÁ∂≠ÊåÅÔºâ
          setTimeout(() => {
            commentElement.classList.remove("slide-in");
            commentElement.classList.add("visible");
            console.log("„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü„ÄÅË°®Á§∫Áä∂ÊÖãÂõ∫ÂÆö:", comment.text);
          }, 800);
        }

        // ÂÖ®„Ç≥„É°„É≥„Éà„Çí‰∏ä„Å´ÁßªÂãï
        moveAllCommentsUp() {
          const commentElements = document.querySelectorAll(".comment-item");
          commentElements.forEach((element) => {
            element.classList.add("moving-up");
            const currentBottom = parseFloat(element.style.bottom) || 0;
            element.style.bottom = currentBottom + 32 + "px";
          });
        }

        // „Ç≥„É°„É≥„Éà‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
        updateCommentPositions() {
          // ÁîªÈù¢Â§ñ„Å´Âá∫„Åü„Ç≥„É°„É≥„Éà„ÇíÂâäÈô§
          const commentElements = document.querySelectorAll(".comment-item");
          commentElements.forEach((element) => {
            const bottom = parseFloat(element.style.bottom) || 0;
            if (bottom > window.innerHeight) {
              element.remove();
            }
          });
        }

        // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´ÈñãÂßãÔºà„Å®„Çä„ÅÇ„Åà„ÅöÁÑ°ÂäπÂåñÔºâ
        startAutoScroll() {
          // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„Çí‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñ„Åó„Å¶„ÉÜ„Çπ„Éà
          console.log("Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÅØÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô");
          // this.autoScrollTimer = setInterval(() => {
          //   this.moveAllCommentsUp();
          //   this.updateCommentPositions();
          // }, this.autoScrollInterval);
        }

        // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´ÂÅúÊ≠¢
        stopAutoScroll() {
          if (this.autoScrollTimer) {
            clearInterval(this.autoScrollTimer);
            this.autoScrollTimer = null;
          }
        }

        // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        destroy() {
          this.stopAutoScroll();
          if (this.ws) {
            this.ws.close();
          }
        }
      }

      // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´ÂàùÊúüÂåñ
      document.addEventListener("DOMContentLoaded", () => {
        window.commentDisplay = new CommentDisplay();
      });

      // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
      window.addEventListener("beforeunload", () => {
        if (window.commentDisplay) {
          window.commentDisplay.destroy();
        }
      });

      // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
      window.addEventListener("error", (event) => {
        console.error("JavaScript„Ç®„É©„Éº:", event.error);
      });

      // Êú™Âá¶ÁêÜ„ÅÆPromiseÊãíÂê¶
      window.addEventListener("unhandledrejection", (event) => {
        console.error("Êú™Âá¶ÁêÜ„ÅÆPromiseÊãíÂê¶:", event.reason);
      });
    </script>
  </body>
</html>
