<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ãƒ‹ã‚³ç”Ÿã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Hachi+Maru+Pop&family=Klee+One&family=RocknRoll+One&family=New+Tegomin&family=Train+One&family=DotGothic16&family=Reggae+One&family=Yuji+Syuku&family=Yuji+Boku&family=Mochiy+Pop+One&family=Kaisei+HarunoUmi&family=Shippori+Antique&family=Stick&family=Rampart+One&family=Zen+Antique&family=Mochiy+Pop+P+One&family=Zen+Kurenaido&family=Yusei+Magic&display=swap"
      rel="stylesheet"
      onerror="console.error('Google Fontsèª­ã¿è¾¼ã¿å¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨');"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        background: transparent;
        overflow: hidden;
        font-family: "DotGothic16", sans-serif;
      }

      #comment-container {
        position: relative;
        width: 512px;
        height: 100vh;
        margin: 0 auto;
      }

      .comment-item {
        position: absolute;
        width: 512px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding-left: 10px;
        transition: all 0.3s ease-out;
        opacity: 0;
        transform: translateX(100%);
      }

      .comment-item.show {
        opacity: 1;
        transform: translateX(0);
      }

      /* ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºå®Ÿã«è¡¨ç¤ºçŠ¶æ…‹ã«ä¿ã¤ */
      .comment-item.visible {
        opacity: 1 !important;
        transform: translateX(0) !important;
        display: flex !important;
      }

      .comment-item.moving-up {
        transition: all 0.2s ease-out;
      }

      .comment-text {
        color: #ffffff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        font-weight: bold;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 480px;
        flex: 1;
        position: relative;
        z-index: 2;
      }

      /* ãƒ•ã‚©ãƒ³ãƒˆå®šç¾©ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰ */
      .font-0 {
        font-family: "DotGothic16", "MS Gothic", monospace, sans-serif;
      } /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
      .font-1 {
        font-family: "Dela Gothic One", "MS Gothic", cursive, sans-serif;
      }
      .font-2 {
        font-family: "Hachi Maru Pop", "MS Gothic", cursive, sans-serif;
      }
      .font-3 {
        font-family: "Klee One", "MS Mincho", cursive, serif;
      }
      .font-4 {
        font-family: "RocknRoll One", "MS Gothic", cursive, sans-serif;
      }
      .font-5 {
        font-family: "New Tegomin", "MS Mincho", serif, sans-serif;
      }
      .font-6 {
        font-family: "Train One", "MS Gothic", cursive, sans-serif;
      }
      .font-7 {
        font-family: "DotGothic16", "MS Gothic", monospace, sans-serif;
      }
      .font-8 {
        font-family: "Reggae One", "MS Gothic", cursive, sans-serif;
      }
      .font-9 {
        font-family: "Yuji Syuku", "MS Mincho", serif, sans-serif;
      }
      .font-10 {
        font-family: "Yuji Boku", "MS Mincho", serif, sans-serif;
      }
      .font-11 {
        font-family: "Mochiy Pop One", "MS Gothic", sans-serif;
      }
      .font-12 {
        font-family: "Kaisei HarunoUmi", "MS Mincho", serif, sans-serif;
      }
      .font-13 {
        font-family: "Shippori Antique", "MS Mincho", serif, sans-serif;
      }
      .font-14 {
        font-family: "Stick", "MS Gothic", sans-serif;
      }
      .font-15 {
        font-family: "Rampart One", "MS Gothic", cursive, sans-serif;
      }
      .font-16 {
        font-family: "Zen Antique", "MS Mincho", serif, sans-serif;
      }
      .font-17 {
        font-family: "Mochiy Pop P One", "MS Gothic", sans-serif;
      }
      .font-18 {
        font-family: "Zen Kurenaido", "MS Gothic", sans-serif;
      }
      .font-19 {
        font-family: "Yusei Magic", "MS Gothic", sans-serif;
      }

      /* ã‚¹ã‚­ãƒ³èƒŒæ™¯ */
      .skin-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: contain;
        background-position: left center;
        background-repeat: no-repeat;
        z-index: 1;
        pointer-events: none;
      }

      /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ  */
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(-32px);
        }
      }

      .slide-in {
        animation: slideIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      }

      .slide-up {
        animation: slideUp 0.2s ease-out forwards;
      }
    </style>
  </head>
  <body>
    <div id="comment-container">
      <!-- ã‚³ãƒ¡ãƒ³ãƒˆãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
    </div>

    <script>
      // ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿çŠ¶æ³ã‚’ç¢ºèª
      document.fonts.ready.then(() => {
        console.log("ğŸ¨ å…¨ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å®Œäº†");
        document.fonts.forEach((font) => {
          console.log(
            `âœ… èª­ã¿è¾¼ã¿æ¸ˆã¿ãƒ•ã‚©ãƒ³ãƒˆ: ${font.family} ${font.style} ${font.weight}`
          );
        });
      });

      // ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®å‡¦ç†
      document.fonts.addEventListener("loadingerror", (event) => {
        console.error("âŒ ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", event);
      });
    </script>
    <script>
      class CommentDisplay {
        constructor() {
          this.container = document.getElementById("comment-container");
          this.comments = [];
          this.maxComments = 20; // æœ€å¤§è¡¨ç¤ºã‚³ãƒ¡ãƒ³ãƒˆæ•°
          this.autoScrollTimer = null;
          this.autoScrollInterval = 60000; // 60ç§’ï¼ˆ1åˆ†ï¼‰

          this.init();
        }

        init() {
          this.connectWebSocket();
          this.startAutoScroll();
          this.loadSkinImages();
        }

        // WebSocketæ¥ç¶š
        connectWebSocket() {
          try {
            this.ws = new WebSocket("ws://localhost:8080/ws");

            this.ws.onopen = () => {
              console.log("WebSocketæ¥ç¶šå®Œäº†");
            };

            this.ws.onmessage = (event) => {
              try {
                const data = JSON.parse(event.data);
                if (data.type === "comment") {
                  this.addComment(data);
                }
              } catch (e) {
                console.error("WebSocketãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:", e);
              }
            };

            this.ws.onerror = (error) => {
              console.error("WebSocketã‚¨ãƒ©ãƒ¼:", error);
            };

            this.ws.onclose = () => {
              console.log("WebSocketæ¥ç¶šçµ‚äº†");
              // å†æ¥ç¶šã‚’è©¦è¡Œ
              setTimeout(() => this.connectWebSocket(), 5000);
            };
          } catch (e) {
            console.error("WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼:", e);
          }
        }

        // ã‚¹ã‚­ãƒ³ç”»åƒèª­ã¿è¾¼ã¿
        loadSkinImages() {
          this.skinImages = {};
          // ã‚¹ã‚­ãƒ³ç”»åƒã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
          console.log("ã‚¹ã‚­ãƒ³ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†");
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
        addComment(data) {
          console.log("ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ :", data); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 

          const comment = {
            id: Date.now() + Math.random(),
            text: data.text || "",
            skin: data.skin || null,
            font: data.font || 0,
            timestamp: Date.now(),
          };

          console.log("å‡¦ç†å¾Œã®ã‚³ãƒ¡ãƒ³ãƒˆ:", comment); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 

          // ã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ 
          this.comments.push(comment);

          // æœ€å¤§è¡¨ç¤ºæ•°ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
          if (this.comments.length > this.maxComments) {
            this.comments.shift();
          }

          // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸Šã«ç§»å‹•
          this.moveAllCommentsUp();

          // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤º
          this.displayComment(comment);

          // ã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’æ›´æ–°
          this.updateCommentPositions();
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
        displayComment(comment) {
          console.log("ã‚¹ã‚­ãƒ³ãƒ»ãƒ•ã‚©ãƒ³ãƒˆé©ç”¨è©³ç´°:", {
            skin: comment.skin,
            font: comment.font,
            text: comment.text,
          });

          const commentElement = document.createElement("div");
          commentElement.className = "comment-item";
          commentElement.id = `comment-${comment.id}`;
          commentElement.style.bottom = "0px";

                  // ã‚¹ã‚­ãƒ³èƒŒæ™¯è¨­å®š
        console.log(`ğŸ¨ ã‚¹ã‚­ãƒ³å‡¦ç†é–‹å§‹ - comment.skin: ${comment.skin} (å‹: ${typeof comment.skin})`);
        
        let skinPath;
        if (comment.skin && comment.skin !== null && comment.skin !== "null") {
          skinPath = `/skin/${comment.skin}.png`;
          console.log(`ğŸ–¼ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ä½¿ç”¨: ${skinPath}`);
        } else {
          skinPath = `/skin/6.png`;
          console.log(`ğŸ–¼ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚­ãƒ³ä½¿ç”¨: ${skinPath}`);
        }

        const skinBg = document.createElement("div");
        skinBg.className = "skin-bg";
        skinBg.style.backgroundImage = `url('${skinPath}')`;
        skinBg.style.border = "2px solid red"; // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚¹ã‚­ãƒ³é ˜åŸŸã‚’å¯è¦–åŒ–
        
        console.log(`ğŸ¯ ã‚¹ã‚­ãƒ³è¦ç´ ä½œæˆå®Œäº† - backgroundImage: ${skinBg.style.backgroundImage}`);

        // ã‚¹ã‚­ãƒ³èª­ã¿è¾¼ã¿ç¢ºèª
        const testImg = new Image();
        testImg.onload = () => {
          console.log(`âœ… ã‚¹ã‚­ãƒ³èª­ã¿è¾¼ã¿æˆåŠŸ: ${skinPath}`);
          // ãƒ‡ãƒãƒƒã‚°ç”¨ã®æ ç·šã‚’å‰Šé™¤
          skinBg.style.border = "none";
        };
        testImg.onerror = () => {
          console.error(`âŒ ã‚¹ã‚­ãƒ³èª­ã¿è¾¼ã¿å¤±æ•—: ${skinPath}`);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚­ãƒ³ã‚’è©¦è¡Œ
          skinBg.style.backgroundImage = `url('/skin/6.png')`;
          skinBg.style.border = "2px solid yellow"; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã¯é»„è‰²
        };
        testImg.src = skinPath;

        commentElement.appendChild(skinBg);
        console.log(`ğŸ“¦ ã‚¹ã‚­ãƒ³è¦ç´ ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«è¿½åŠ å®Œäº†`);

          // ã‚³ãƒ¡ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆ
          const fontClass = `font-${comment.font || 0}`;
          const textElement = document.createElement("div");
          textElement.className = `comment-text ${fontClass}`;
          textElement.textContent = comment.text;
          console.log(`ãƒ•ã‚©ãƒ³ãƒˆã‚¯ãƒ©ã‚¹é©ç”¨: ${fontClass}`);

          // ãƒ•ã‚©ãƒ³ãƒˆé©ç”¨ç¢ºèª
          const computedStyle = window.getComputedStyle(textElement);
          console.log(`å®Ÿéš›ã®ãƒ•ã‚©ãƒ³ãƒˆ: ${computedStyle.fontFamily}`);

          commentElement.appendChild(textElement);

          // ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
          this.container.appendChild(commentElement);

          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆå³ã‹ã‚‰å·¦ã«é£›ã³è¾¼ã‚€ï¼‰
          requestAnimationFrame(() => {
            commentElement.classList.add("slide-in");
            console.log("ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹:", comment.text);
          });

          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã®å‡¦ç†ï¼ˆè¡¨ç¤ºçŠ¶æ…‹ã‚’ç¶­æŒï¼‰
          setTimeout(() => {
            commentElement.classList.remove("slide-in");
            commentElement.classList.add("visible");
            console.log("ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ã€è¡¨ç¤ºçŠ¶æ…‹å›ºå®š:", comment.text);
          }, 800);
        }

        // å…¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸Šã«ç§»å‹•
        moveAllCommentsUp() {
          const commentElements = document.querySelectorAll(".comment-item");
          commentElements.forEach((element) => {
            element.classList.add("moving-up");
            const currentBottom = parseFloat(element.style.bottom) || 0;
            element.style.bottom = currentBottom + 32 + "px";
          });
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆä½ç½®ã‚’æ›´æ–°
        updateCommentPositions() {
          // ç”»é¢å¤–ã«å‡ºãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
          const commentElements = document.querySelectorAll(".comment-item");
          commentElements.forEach((element) => {
            const bottom = parseFloat(element.style.bottom) || 0;
            if (bottom > window.innerHeight) {
              element.remove();
            }
          });
        }

        // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–‹å§‹ï¼ˆã¨ã‚Šã‚ãˆãšç„¡åŠ¹åŒ–ï¼‰
        startAutoScroll() {
          // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã—ã¦ãƒ†ã‚¹ãƒˆ
          console.log("è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™");
          // this.autoScrollTimer = setInterval(() => {
          //   this.moveAllCommentsUp();
          //   this.updateCommentPositions();
          // }, this.autoScrollInterval);
        }

        // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åœæ­¢
        stopAutoScroll() {
          if (this.autoScrollTimer) {
            clearInterval(this.autoScrollTimer);
            this.autoScrollTimer = null;
          }
        }

        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        destroy() {
          this.stopAutoScroll();
          if (this.ws) {
            this.ws.close();
          }
        }
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
      document.addEventListener("DOMContentLoaded", () => {
        window.commentDisplay = new CommentDisplay();
      });

      // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      window.addEventListener("beforeunload", () => {
        if (window.commentDisplay) {
          window.commentDisplay.destroy();
        }
      });

      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      window.addEventListener("error", (event) => {
        console.error("JavaScriptã‚¨ãƒ©ãƒ¼:", event.error);
      });

      // æœªå‡¦ç†ã®Promiseæ‹’å¦
      window.addEventListener("unhandledrejection", (event) => {
        console.error("æœªå‡¦ç†ã®Promiseæ‹’å¦:", event.reason);
      });
    </script>
  </body>
</html>
